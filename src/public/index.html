<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cadastro WhatsApp Business - CoExistence</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 600px;
      width: 100%;
      padding: 40px;
    }

    .logo {
      text-align: center;
      margin-bottom: 30px;
    }

    .logo svg {
      width: 80px;
      height: 80px;
      fill: #25D366;
    }

    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 10px;
      font-size: 28px;
    }

    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
      font-size: 16px;
    }

    .info-box {
      background: #f8f9fa;
      border-left: 4px solid #25D366;
      padding: 15px;
      margin-bottom: 30px;
      border-radius: 5px;
    }

    .info-box h3 {
      color: #25D366;
      margin-bottom: 10px;
      font-size: 16px;
    }

    .info-box ul {
      list-style: none;
      padding-left: 0;
    }

    .info-box li {
      padding: 5px 0;
      color: #555;
      font-size: 14px;
    }

    .info-box li:before {
      content: "‚úì ";
      color: #25D366;
      font-weight: bold;
      margin-right: 5px;
    }

    .button-container {
      text-align: center;
      margin-top: 30px;
    }

    #signup-button {
      background: #25D366;
      color: white;
      border: none;
      padding: 15px 40px;
      font-size: 18px;
      font-weight: bold;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(37, 211, 102, 0.4);
    }

    #signup-button:hover {
      background: #20bd5a;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(37, 211, 102, 0.5);
    }

    #signup-button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .status {
      margin-top: 20px;
      padding: 15px;
      border-radius: 5px;
      display: none;
    }

    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .footer {
      text-align: center;
      margin-top: 30px;
      color: #999;
      font-size: 12px;
    }

    .coexistence-badge {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 20px;
      text-align: center;
      color: #856404;
      font-size: 14px;
    }

    .coexistence-badge strong {
      color: #25D366;
    }

    @media (max-width: 600px) {
      .container {
        padding: 20px;
      }

      h1 {
        font-size: 24px;
      }

      #signup-button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">
      <!-- WhatsApp Logo SVG -->
      <svg viewBox="0 0 175.216 175.552">
        <defs>
          <linearGradient id="b" x1="85.915" x2="86.535" y1="32.567" y2="137.092" gradientUnits="userSpaceOnUse">
            <stop offset="0" stop-color="#57d163"/>
            <stop offset="1" stop-color="#23b33a"/>
          </linearGradient>
        </defs>
        <path fill="url(#b)" d="M87.184 25.227c-33.733 0-61.166 27.423-61.178 61.13a60.98 60.98 0 0 0 9.349 32.535l1.455 2.312-6.179 22.559 23.146-6.069 2.235 1.324c9.387 5.571 20.15 8.518 31.126 8.524h.023c33.707 0 61.14-27.426 61.153-61.135a60.75 60.75 0 0 0-17.895-43.251 60.75 60.75 0 0 0-43.235-17.929z"/>
        <path fill="#fff" d="M68.772 55.603c-1.378-3.061-2.828-3.123-4.137-3.176l-3.524-.043c-1.226 0-3.218.46-4.902 2.3s-6.435 6.287-6.435 15.332 6.588 17.785 7.506 19.013 12.718 20.381 31.405 27.75c15.529 6.124 18.689 4.906 22.061 4.6s10.877-4.447 12.408-8.74 1.532-7.971 1.073-8.74-1.685-1.226-3.525-2.146-10.877-5.367-12.562-5.981-2.91-.919-4.137.921-4.746 5.979-5.819 7.206-2.144 1.381-3.984.462-7.76-2.861-14.784-9.124c-5.465-4.873-9.154-10.891-10.228-12.73s-.114-2.835.808-3.751c.825-.824 1.838-2.147 2.759-3.22s1.224-1.84 1.836-3.065.307-2.301-.153-3.22-4.032-10.011-5.666-13.647"/>
      </svg>
    </div>

    <h1>WhatsApp Business Platform</h1>
    <p class="subtitle">Cadastro Incorporado com CoExistence</p>

    <div class="coexistence-badge">
      <strong>‚ú® CoExistence Habilitado</strong><br>
      Use seu n√∫mero existente do WhatsApp Business App
    </div>

    <div class="info-box">
      <h3>üìã O que voc√™ receber√°:</h3>
      <ul>
        <li>WABA ID (WhatsApp Business Account ID)</li>
        <li>Phone Number ID do seu n√∫mero</li>
        <li>Token de acesso √† API</li>
        <li>Acesso completo √† API do WhatsApp Business</li>
      </ul>
    </div>

    <div class="info-box">
      <h3>üîê Como funciona:</h3>
      <ul>
        <li>Clique no bot√£o abaixo</li>
        <li>Fa√ßa login com sua conta Facebook/Meta</li>
        <li>Aceite as permiss√µes necess√°rias</li>
        <li>Selecione ou crie seu WhatsApp Business Account</li>
        <li>Use seu n√∫mero existente do WhatsApp Business App</li>
        <li>Pronto! Voc√™ receber√° as credenciais da API</li>
      </ul>
    </div>

    <div class="button-container">
      <button id="signup-button" onclick="launchWhatsAppSignup()">
        üöÄ Iniciar Cadastro
      </button>
    </div>

    <div id="status" class="status"></div>

    <div class="footer">
      <p>Powered by Meta WhatsApp Business Platform</p>
      <p>¬© 2025 - Todos os direitos reservados</p>
    </div>
  </div>

  <!-- Script principal -->
  <script>
    // Configura√ß√µes carregadas do servidor
    let FACEBOOK_APP_ID = '';
    let FACEBOOK_CONFIG_ID = '';

    // Buscar configura√ß√µes do servidor
    fetch('/api/config')
      .then(res => res.json())
      .then(config => {
        FACEBOOK_APP_ID = config.appId;
        FACEBOOK_CONFIG_ID = config.configId;
        
        // Verificar se as credenciais foram configuradas
        if (!FACEBOOK_APP_ID || !FACEBOOK_CONFIG_ID) {
          showStatus('‚ö†Ô∏è ATEN√á√ÉO: Configure as credenciais do Facebook no arquivo .env', 'error');
          document.getElementById('signup-button').disabled = true;
        } else {
          console.log('‚úÖ Configura√ß√µes carregadas:', { appId: FACEBOOK_APP_ID, configId: FACEBOOK_CONFIG_ID });
        }
      })
      .catch(error => {
        console.error('Erro ao carregar configura√ß√µes:', error);
        showStatus('‚ö†Ô∏è Erro ao carregar configura√ß√µes. Recarregue a p√°gina.', 'error');
        document.getElementById('signup-button').disabled = true;
      });

    // Fun√ß√£o para lan√ßar o Embedded Signup
    function launchWhatsAppSignup() {
      const button = document.getElementById('signup-button');
      const status = document.getElementById('status');
      
      // Verificar se as configura√ß√µes foram carregadas
      if (!FACEBOOK_APP_ID || !FACEBOOK_CONFIG_ID) {
        showStatus('‚ö†Ô∏è Aguarde o carregamento das configura√ß√µes...', 'error');
        return;
      }
      
      button.disabled = true;
      button.textContent = '‚è≥ Carregando...';
      
      // Esconde mensagens anteriores
      status.style.display = 'none';

      console.log('üöÄ Iniciando Embedded Signup com CoExistence...');

      // URL do Embedded Signup com CoExistence (vers√£o v3)
      const signupUrl = new URL('https://business.facebook.com/messaging/whatsapp/onboard/');
      signupUrl.searchParams.append('app_id', FACEBOOK_APP_ID);
      signupUrl.searchParams.append('config_id', FACEBOOK_CONFIG_ID);
      
      // Extras com configura√ß√£o de CoExistence v3
      const extras = {
        featureType: 'whatsapp_business_app_onboarding', // ‚Üê CORRETO para CoExistence!
        sessionInfoVersion: '3'
      };
      signupUrl.searchParams.append('extras', JSON.stringify(extras));
      
      // IMPORTANTE: Adiciona redirect_uri como fallback
      signupUrl.searchParams.append('redirect_uri', window.location.origin + '/auth/callback');

      console.log('üìç URL Embedded Signup:', signupUrl.toString());

      // Abrir popup do Embedded Signup
      const width = 600;
      const height = 800;
      const left = (window.screen.width - width) / 2;
      const top = (window.screen.height - height) / 2;
      
      const popup = window.open(
        signupUrl.toString(),
        'whatsapp_signup',
        `width=${width},height=${height},left=${left},top=${top},toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes`
      );

      if (!popup) {
        showStatus('‚ùå Pop-up bloqueado! Permita pop-ups para este site.', 'error');
        button.disabled = false;
        button.textContent = 'üöÄ Iniciar Cadastro';
        return;
      }

      // Escutar mensagens do popup - VERS√ÉO ROBUSTA
      const messageHandler = function(event) {
        // Log TUDO que chegar para debugging
        console.log('üîî QUALQUER evento recebido:', {
          origin: event.origin,
          data: event.data,
          type: typeof event.data,
          keys: event.data ? Object.keys(event.data) : 'null',
          timestamp: new Date().toISOString()
        });

        // Verificar origem (aceita tanto business.facebook.com quanto www.facebook.com)
        if (!event.origin.includes('facebook.com')) {
          console.warn('‚ö†Ô∏è Origem n√£o confi√°vel, mas registrando:', event.origin);
          // N√ÉO retorna aqui - vamos processar mesmo assim para debug
        } else {
          console.log('‚úÖ Origem v√°lida, processando mensagem...');
        }

        // Tentar m√∫ltiplos formatos de evento
        let signupData = null;

        // Formato 1: WA_EMBEDDED_SIGNUP padr√£o (v2)
        if (event.data && event.data.type === 'WA_EMBEDDED_SIGNUP') {
          console.log('üì¨ Tipo WA_EMBEDDED_SIGNUP detectado, evento:', event.data.event);
          
          if (event.data.event === 'FINISH') {
            console.log('‚úÖ Formato 1: WA_EMBEDDED_SIGNUP FINISH');
            signupData = event.data.data;
          } else if (event.data.event === 'CANCEL') {
            console.log('‚ùå Signup cancelado pelo usu√°rio');
            signupCompleted = true; // Marcar como completado para evitar mensagem de erro
            showStatus('Cadastro cancelado', 'error');
            button.disabled = false;
            button.textContent = 'üöÄ Iniciar Cadastro';
            popup.close();
            window.removeEventListener('message', messageHandler);
            return;
          } else if (event.data.event === 'ERROR') {
            console.error('‚ùå Erro reportado pelo Embedded Signup:', event.data);
            signupCompleted = true; // Marcar como completado para evitar mensagem de erro duplicada
            showStatus('‚ùå Erro: ' + (event.data.error || 'Erro desconhecido'), 'error');
            button.disabled = false;
            button.textContent = 'üöÄ Iniciar Cadastro';
            return;
          } else {
            console.log('‚ÑπÔ∏è Evento WA_EMBEDDED_SIGNUP desconhecido:', event.data.event);
          }
        }
        
        // Formato 2: Evento direto sem wrapper type (v3)
        else if (event.data && (event.data.event === 'FINISH' || event.data.event === 'finish')) {
          console.log('‚úÖ Formato 2: Evento FINISH direto detectado');
          signupData = event.data.data || event.data;
        }
        
        // Formato 3: Dados diretos sem event wrapper (v3 alternativo)
        else if (event.data && event.data.phone_number_id && event.data.waba_id) {
          console.log('‚úÖ Formato 3: Dados diretos detectados (sem wrapper)');
          signupData = event.data;
        }

        // Se encontrou dados v√°lidos, processar
        if (signupData && (signupData.phone_number_id || signupData.waba_id)) {
          console.log('üì¶ Dados de signup v√°lidos encontrados:', {
            phone_number_id: signupData.phone_number_id,
            waba_id: signupData.waba_id,
            code: signupData.code ? 'presente' : 'ausente',
            data_completo: signupData
          });
          
          // Marcar como completado IMEDIATAMENTE ao receber dados v√°lidos
          signupCompleted = true;
          console.log('‚úÖ Flag signupCompleted = true');
          
          // Enviar dados para o backend
          console.log('üì§ Enviando dados para /auth/callback...');
          
          fetch('/auth/callback', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              phone_number_id: signupData.phone_number_id,
              waba_id: signupData.waba_id,
              code: signupData.code || null
            })
          })
          .then(res => {
            console.log('üì• Resposta recebida, status:', res.status);
            return res.json();
          })
          .then(result => {
            console.log('üìä Resultado processado:', result);
            
            if (result.success) {
              showStatus('‚úÖ WhatsApp conectado com sucesso!', 'success');
              console.log('‚úÖ Conta configurada:', result);
            } else {
              showStatus('‚ùå Erro ao processar: ' + result.message, 'error');
              console.error('‚ùå Erro do servidor:', result);
            }
            button.disabled = false;
            button.textContent = 'üöÄ Iniciar Cadastro';
          })
          .catch(error => {
            console.error('‚ùå Erro na requisi√ß√£o:', error);
            showStatus('‚ùå Erro na requisi√ß√£o: ' + error.message, 'error');
            button.disabled = false;
            button.textContent = 'üöÄ Iniciar Cadastro';
          });
          
          // Fechar popup
          console.log('üîí Fechando popup...');
          popup.close();
          
          // Remover listener
          window.removeEventListener('message', messageHandler);
          console.log('‚úÖ Listener removido');
        } else if (event.data) {
          console.log('‚ÑπÔ∏è Evento recebido mas sem dados v√°lidos de signup:', event.data);
        }
      };

      console.log('üëÇ Event listener adicionado');
      window.addEventListener('message', messageHandler);

      // Flag para rastrear se houve sucesso
      let signupCompleted = false;

      // Verificar se popup foi fechado manualmente
      const checkPopup = setInterval(function() {
        if (popup.closed) {
          clearInterval(checkPopup);
          window.removeEventListener('message', messageHandler);
          
          // S√≥ mostra erro se N√ÉO houve sucesso
          if (!signupCompleted && button.disabled) {
            console.log('‚ö†Ô∏è Popup fechado sem completar o signup');
            showStatus('Popup fechado. Tente novamente se necess√°rio.', 'error');
            button.disabled = false;
            button.textContent = 'üöÄ Iniciar Cadastro';
          } else if (signupCompleted) {
            console.log('‚úÖ Popup fechado ap√≥s sucesso - tudo OK');
          }
        }
      }, 500);
    }

    // Fun√ß√£o para mostrar mensagens de status
    function showStatus(message, type) {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = 'status ' + type;
      status.style.display = 'block';
    }

    // Escuta mensagens de sucesso do popup
    window.addEventListener('message', function(event) {
      if (event.data.type === 'signup_success') {
        showStatus('‚úÖ Cadastro conclu√≠do com sucesso!', 'success');
        console.log('Business Data:', event.data.data);
      }
    });
  </script>
</body>
</html>
